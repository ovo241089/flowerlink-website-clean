@{
    ViewBag.Title = "My Order History";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="breadcrumb-area section-ptb">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h2 class="breadcrumb-title">My Order History</h2>
                <ul class="breadcrumb-list">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("MyAccount", "Account")">My Account</a></li>
                    <li class="breadcrumb-item active">Order History</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="container section-ptb">
    <div class="row">
        <div class="col-lg-12">
            <h4>Your Orders</h4>
            <div id="orderHistoryTableContainer" class="table-responsive mt-3">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Order No</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orderHistoryTableBody">
                        <!-- Orders will be loaded here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="orderHistoryLoading" class="text-center mt-3" style="display:none;">
                <p>Loading your order history...</p>
            </div>
            <div id="orderHistoryError" class="mt-3 alert alert-danger" style="display:none;"></div>
            <div id="noOrdersFound" class="mt-3 alert alert-info" style="display:none;">You have no orders yet.</div>
        </div>
    </div>
</div>

<!-- Modal for Order Details -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" role="dialog" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalOrderStatusResult">
                    <p><strong>Order ID:</strong> <span id="modalResultOrderId"></span></p>
                    <p><strong>Order Number:</strong> <span id="modalResultOrderNo"></span></p>
                    <p><strong>Order Date:</strong> <span id="modalResultOrderDate"></span></p>
                    <p><strong>Current Status:</strong> <span id="modalResultCurrentStatus" class="badge"></span></p>
                    <p><strong>Total Amount:</strong> BD <span id="modalResultTotalAmount"></span></p>
                    
                    <h5 class="mt-4">Items in this Order:</h5>
                    <ul id="modalResultOrderItems" class="list-group mb-3"></ul>
                    
                    <h5 class="mt-4">Order History:</h5>
                    <ul id="modalResultOrderStatusHistory" class="list-group"></ul>
                </div>
                <div id="modalOrderStatusError" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
        $(document).ready(function () {
            loadOrderHistory();

            function loadOrderHistory() {
                $("#orderHistoryLoading").show();
                $("#orderHistoryError").hide();
                $("#noOrdersFound").hide();
                $("#orderHistoryTableBody").empty();

                $.ajax({
                    url: "@Url.Action("GetCustomerOrderHistory", "Order")",
                    type: "GET",
                    success: function (response) {
                        $("#orderHistoryLoading").hide();
                        if (response.success && response.data) {
                            if (response.data.length > 0) {
                                response.data.forEach(function (order) {
                                    var row = `<tr>
                                        <td>${order.OrderID}</td>
                                        <td>${order.OrderNo}</td>
                                        <td>${new Date(order.OrderDate).toLocaleDateString()}</td>
                                        <td><span class="badge badge-${getStatusBadgeClass(order.Status)}">${order.Status}</span></td>
                                        <td>BD ${parseFloat(order.GrandTotal).toFixed(2)}</td>
                                        <td><button class="btn btn-sm btn-info view-order-details" data-order-id="${order.OrderID}">View Details</button></td>
                                    </tr>`;
                                    $("#orderHistoryTableBody").append(row);
                                });
                            } else {
                                $("#noOrdersFound").text(response.message || "No orders found.").show();
                            }
                        } else {
                            $("#orderHistoryError").text(response.message || "Could not retrieve order history.").show();
                        }
                    },
                    error: function (xhr, status, error) {
                        $("#orderHistoryLoading").hide();
                        if (xhr.status === 401) { // Unauthorized, likely session expired or not logged in
                             $("#orderHistoryError").html("You are not authorized to view this page. Please <a href='@Url.Action("Login_Register", "Account", new { id = 1 })'>login</a>.").show();
                        } else {
                            $("#orderHistoryError").text("An error occurred while fetching your order history. Please try again later.").show();
                        }
                        console.error("Order History Error: ", xhr.responseText);
                    }
                });
            }

            // Handle click for viewing order details
            $(document).on("click", ".view-order-details", function() {
                var orderId = $(this).data("order-id");
                loadOrderDetailsIntoModal(orderId);
            });

            function loadOrderDetailsIntoModal(orderId) {
                $("#modalOrderStatusResult").hide();
                $("#modalOrderStatusError").hide();
                $("#modalResultOrderItems").empty();
                $("#modalResultOrderStatusHistory").empty();

                var apiUrl = "@Url.Action("GetOrderStatus", "Order")" + "/" + orderId;
                // No email needed here as GetOrderStatus in controller will check session for logged-in user

                $.ajax({
                    url: apiUrl,
                    type: "GET",
                    success: function (response) {
                        if (response.success && response.data) {
                            var order = response.data;
                            $("#modalResultOrderId").text(order.OrderID);
                            $("#modalResultOrderNo").text(order.OrderNo);
                            $("#modalResultOrderDate").text(new Date(order.OrderDate).toLocaleDateString() + " " + new Date(order.OrderDate).toLocaleTimeString());
                            $("#modalResultCurrentStatus").text(order.CurrentStatus).removeClass("badge-info badge-success badge-warning badge-danger badge-secondary").addClass("badge-" + getStatusBadgeClass(order.CurrentStatus));
                            $("#modalResultTotalAmount").text(parseFloat(order.TotalAmount).toFixed(2));

                            if (order.Items && order.Items.length > 0) {
                                order.Items.forEach(function(item) {
                                    $("#modalResultOrderItems").append("<li class=\"list-group-item d-flex justify-content-between align-items-center\">" + item.ProductName + " (Qty: " + item.Quantity + ") <span class=\"badge badge-primary badge-pill\">BD " + parseFloat(item.TotalPrice).toFixed(2) + "</span></li>");
                                });
                            } else {
                                $("#modalResultOrderItems").append("<li class=\"list-group-item\">No items found for this order.</li>");
                            }

                            if (order.History && order.History.length > 0) {
                                order.History.forEach(function(historyItem) {
                                    $("#modalResultOrderStatusHistory").append("<li class=\"list-group-item\"><strong>" + historyItem.Status + ":</strong> " + new Date(historyItem.Timestamp).toLocaleString() + (historyItem.Notes ? " - <em>" + historyItem.Notes + "</em>" : "") + "</li>");
                                });
                            } else {
                                $("#modalResultOrderStatusHistory").append("<li class=\"list-group-item\">No status history available.</li>");
                            }
                            $("#modalOrderStatusResult").show();
                            $("#orderDetailsModal").modal("show");
                        } else {
                            $("#modalOrderStatusError").text(response.message || "Could not retrieve order details.").show();
                            $("#orderDetailsModal").modal("show"); // Show modal even on error to display message
                        }
                    },
                    error: function (xhr, status, error) {
                        $("#modalOrderStatusError").text("An error occurred while fetching order details.").show();
                        $("#orderDetailsModal").modal("show");
                        console.error("Order Details Modal Error: ", xhr.responseText);
                    }
                });
            }

            function getStatusBadgeClass(status) {
                if (!status) return "secondary";
                status = status.toLowerCase();
                if (status.includes("delivered") || status.includes("completed")) return "success";
                if (status.includes("shipped") || status.includes("processing") || status.includes("progress")) return "info";
                if (status.includes("pending") || status.includes("placed")) return "warning";
                if (status.includes("cancelled") || status.includes("failed") || status.includes("rejected")) return "danger";
                return "secondary"; // Default
            }
        });
    </script>
}

